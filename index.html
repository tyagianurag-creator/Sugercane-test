<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KisanAI üåæ</title>

  <!-- TensorFlow JS -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0/dist/tf.min.js"></script>

  <!-- Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }

    img { margin-top: 20px; }

    #result {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }

    button {
      padding: 10px 14px;
      margin: 6px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
    }

    #warning {
      color: #b71c1c;
      font-weight: bold;
    }

    .low-confidence {
      border: 2px solid #b71c1c;
    }
  </style>
</head>

<body>

  <h1 id="title">KisanAI üåæ</h1>

  <div style="margin-bottom:12px;">
    <button id="langToggle">Switch to ‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
  </div>

  <input type="file" id="imageUpload" accept="image/*">
  <div id="preview"></div>
  <div id="result"></div>
  <div id="warning" style="margin-top:10px; font-size:16px; display:none;"></div>
  <div id="treatment" style="margin-top:10px; font-size:16px;"></div>

  <div id="actions" style="margin-top:16px; display:none;">
    <button id="btnCorrect">‚úÖ Correct</button>
    <button id="btnWrong">‚ùå Wrong</button>
    <button id="btnExpert">üí¨ WhatsApp Expert</button>
  </div>

<script>
  let model;
  let modelReady = false;

  let lastPrediction = null;
  let lastConfidence = null; // store last confidence so warning can re-render on language change

  const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSem_oTTQBtdWz8NBy8Joh0WTU6NHorbT4O8eHg6-ysgozgjBg/viewform?usp=pp_url";

  // Language state (persist in browser)
  let lang = localStorage.getItem("kisanai_lang") || "en"; // "en" or "hi"

  const T = {
    en: {
      title: "KisanAI üåæ",
      correct: "‚úÖ Correct",
      wrong: "‚ùå Wrong",
      expert: "üí¨ WhatsApp Expert",
      lowConf: "‚ö†Ô∏è Low confidence. Please take a clearer photo or consult expert on WhatsApp.",
      predPrefix: "Prediction: ",
      switchTo: "Switch to ‡§π‡§ø‡§Ç‡§¶‡•Ä"
    },
    hi: {
      title: "‡§ï‡§ø‡§∏‡§æ‡§® AI üåæ",
      correct: "‚úÖ ‡§∏‡§π‡•Ä",
      wrong: "‚ùå ‡§ó‡§≤‡§§",
      expert: "üí¨ WhatsApp ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ",
      lowConf: "‚ö†Ô∏è ‡§ï‡§Æ ‡§≠‡§∞‡•ã‡§∏‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§æ‡§´‡§º ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç ‡§Ø‡§æ WhatsApp ‡§™‡§∞ ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç‡•§",
      predPrefix: "‡§®‡§§‡•Ä‡§ú‡§æ: ",
      switchTo: "Switch to English"
    }
  };

  function getTreatment(disease) {
    const d = (disease || "").toLowerCase();

    if (d.includes("red")) {
      return {
        en: "Remove infected plants. Avoid water stagnation. Use recommended fungicide.",
        hi: "‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§ø‡§§ ‡§™‡•å‡§ß‡•á ‡§π‡§ü‡§æ‡§è‡§Ç‡•§ ‡§ñ‡•á‡§§ ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§®‡•Ä ‡§ú‡§Æ‡§æ ‡§® ‡§π‡•ã‡§®‡•á ‡§¶‡•á‡§Ç‡•§ ‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§ ‡§´‡§´‡•Ç‡§Ç‡§¶‡§®‡§æ‡§∂‡§ï ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§"
      };
    }

    if (d.includes("smut")) {
      return {
        en: "Remove smut whips early. Use disease-free seed cane. Avoid ratoon from infected fields.",
        hi: "‡§∏‡•ç‡§Æ‡§ü ‡§µ‡•ç‡§π‡§ø‡§™‡•ç‡§∏ ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§π‡§ü‡§æ‡§è‡§Ç‡•§ ‡§∞‡•ã‡§ó‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§¨‡•Ä‡§ú ‡§≤‡•á‡§Ç‡•§ ‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§ø‡§§ ‡§ñ‡•á‡§§ ‡§∏‡•á ‡§∞atoon ‡§® ‡§≤‡•á‡§Ç‡•§"
      };
    }

    if (d.includes("healthy")) {
      return {
        en: "Crop looks healthy. Maintain proper irrigation and regular inspection.",
        hi: "‡§´‡§∏‡§≤ ‡§∏‡•ç‡§µ‡§∏‡•ç‡§• ‡§¶‡§ø‡§ñ ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ ‡§â‡§ö‡§ø‡§§ ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§î‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç‡•§"
      };
    }

    return { en: "", hi: "" };
  }

  function renderWarning() {
    const warningEl = document.getElementById("warning");
    const expertBtn = document.getElementById("btnExpert");

    // Reset
    warningEl.style.display = "none";
    warningEl.innerText = "";
    expertBtn.classList.remove("low-confidence");

    if (lastConfidence !== null && lastConfidence < 70) {
      warningEl.style.display = "block";
      warningEl.innerText = T[lang].lowConf;
      expertBtn.classList.add("low-confidence");
    }
  }

  function applyLang() {
    document.getElementById("title").innerText = T[lang].title;
    document.getElementById("btnCorrect").innerText = T[lang].correct;
    document.getElementById("btnWrong").innerText = T[lang].wrong;
    document.getElementById("btnExpert").innerText = T[lang].expert;

    // Button label shows what it will switch TO (clear & not confusing)
    document.getElementById("langToggle").innerText = T[lang].switchTo;

    // Re-render result/treatment/warning if we already predicted
    if (lastPrediction) {
      document.getElementById("result").innerText =
        T[lang].predPrefix +
        lastPrediction.className +
        " (" + (lastConfidence ?? (lastPrediction.probability * 100)).toFixed(2) + "%)";

      const treatmentData = getTreatment(lastPrediction.className);
      document.getElementById("treatment").innerText = treatmentData[lang] || "";
    }

    renderWarning();
  }

  document.getElementById("langToggle").onclick = function() {
    lang = (lang === "en") ? "hi" : "en";
    localStorage.setItem("kisanai_lang", lang);
    applyLang();
  };

  applyLang();

  async function loadModel() {
    model = await tmImage.load("./model.json", "./metadata.json");
    modelReady = true;
    console.log("Model Loaded Successfully");
  }
  loadModel();

  document.getElementById("imageUpload").addEventListener("change", async function (event) {
    if (!modelReady) {
      alert("Model is still loading. Please wait a few seconds and try again.");
      return;
    }

    const file = event.target.files[0];
    if (!file) return;

    const img = document.createElement("img");
    img.src = window.URL.createObjectURL(file);
    img.width = 300;

    const preview = document.getElementById("preview");
    preview.innerHTML = "";
    preview.appendChild(img);

    img.onload = async () => {
      const prediction = await model.predict(img);
      prediction.sort((a, b) => b.probability - a.probability);

      const top = prediction[0];
      const confidence = top.probability * 100;

      lastPrediction = top;
      lastConfidence = confidence;

      // Treatment
      const treatmentData = getTreatment(top.className);
      document.getElementById("treatment").innerText = treatmentData[lang] || "";

      // Result
      document.getElementById("result").innerText =
        T[lang].predPrefix + top.className + " (" + confidence.toFixed(2) + "%)";

      // Warning (uses current language)
      renderWarning();

      // Show action buttons
      document.getElementById("actions").style.display = "block";

      // WhatsApp
      document.getElementById("btnExpert").onclick = function() {
        window.open(
          "https://wa.me/919999955233?text=" +
          encodeURIComponent(
            "KisanAI Result:\n" +
            top.className + " (" + confidence.toFixed(2) + "%)"
          ),
          "_blank"
        );
      };

      // Feedback
      document.getElementById("btnCorrect").onclick = function() {
        openFeedbackForm("Yes");
      };
      document.getElementById("btnWrong").onclick = function() {
        openFeedbackForm("No");
      };
    };
  });

  function openFeedbackForm(correctValue) {
    if (!lastPrediction) return;

    const disease = encodeURIComponent(lastPrediction.className);
    const conf = encodeURIComponent((lastConfidence ?? (lastPrediction.probability * 100)).toFixed(2));
    const correct = encodeURIComponent(correctValue);

    const url =
      FORM_BASE +
      "&entry.1340582940=" + disease +
      "&entry.432078826=" + conf +
      "&entry.2027263940=" + correct;

    window.open(url, "_blank");
  }
</script>

</body>
</html>
