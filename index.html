<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KisanAI ЁЯМ╛</title>

  <!-- TensorFlow JS -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0/dist/tf.min.js"></script>

  <!-- Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }

    img {
      margin-top: 20px;
    }

    #result {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }

    button {
      padding: 10px 14px;
      margin: 6px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
    }

    #warning {
      color: #b71c1c;
      font-weight: bold;
    }

    .low-confidence {
      border: 2px solid #b71c1c;
    }
  </style>
</head>

<body>

  <h1 id="title">KisanAI ЁЯМ╛</h1>

  <div style="margin-bottom:12px;">
    <button id="langToggle">ЁЯМР рд╣рд┐рдВрджреА</button>
  </div>

  <input type="file" id="imageUpload" accept="image/*">
  <div id="preview"></div>
  <div id="result"></div>
  <div id="warning" style="margin-top:10px; font-size:16px; display:none;"></div>
  <div id="treatment" style="margin-top:10px; font-size:16px;"></div>

  <div id="actions" style="margin-top:16px; display:none;">
    <button id="btnCorrect">тЬЕ Correct</button>
    <button id="btnWrong">тЭМ Wrong</button>
    <button id="btnExpert">ЁЯТм WhatsApp Expert</button>
  </div>

<script>

  let model;
  let modelReady = false;
  let lastPrediction = null;

  const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSem_oTTQBtdWz8NBy8Joh0WTU6NHorbT4O8eHg6-ysgozgjBg/viewform?usp=pp_url";

  let lang = "en";

  const T = {
    en: {
      title: "KisanAI ЁЯМ╛",
      correct: "тЬЕ Correct",
      wrong: "тЭМ Wrong",
      expert: "ЁЯТм WhatsApp Expert",
      lowConf: "тЪая╕П Low confidence. Please take a clearer photo or consult expert on WhatsApp.",
      predPrefix: "Prediction: "
    },
    hi: {
      title: "рдХрд┐рд╕рд╛рди AI ЁЯМ╛",
      correct: "тЬЕ рд╕рд╣реА",
      wrong: "тЭМ рдЧрд▓рдд",
      expert: "ЁЯТм WhatsApp рд╕рд╣рд╛рдпрддрд╛",
      lowConf: "тЪая╕П рдХрдо рднрд░реЛрд╕рд╛ред рдХреГрдкрдпрд╛ рд╕рд╛рдлрд╝ рдлреЛрдЯреЛ рд▓реЗрдВ рдпрд╛ WhatsApp рдкрд░ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рд╕реЗ рдкреВрдЫреЗрдВред",
      predPrefix: "рдирддреАрдЬрд╛: "
    }
  };

  function getTreatment(disease) {
    const d = disease.toLowerCase();

    if (d.includes("red")) {
      return {
        en: "Remove infected plants. Avoid water stagnation. Use recommended fungicide.",
        hi: "рд╕рдВрдХреНрд░рдорд┐рдд рдкреМрдзреЗ рд╣рдЯрд╛рдПрдВред рдЦреЗрдд рдореЗрдВ рдкрд╛рдиреА рдЬрдорд╛ рди рд╣реЛрдиреЗ рджреЗрдВред рдЕрдиреБрд╢рдВрд╕рд┐рдд рдлрдлреВрдВрджрдирд╛рд╢рдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред"
      };
    }

    if (d.includes("smut")) {
      return {
        en: "Remove smut whips early. Use disease-free seed cane. Avoid ratoon from infected fields.",
        hi: "рд╕реНрдордЯ рд╡реНрд╣рд┐рдкреНрд╕ рдЬрд▓реНрджреА рд╣рдЯрд╛рдПрдВред рд░реЛрдЧрдореБрдХреНрдд рдмреАрдЬ рд▓реЗрдВред рд╕рдВрдХреНрд░рдорд┐рдд рдЦреЗрдд рд╕реЗ рд░atoon рди рд▓реЗрдВред"
      };
    }

    if (d.includes("healthy")) {
      return {
        en: "Crop looks healthy. Maintain proper irrigation and regular inspection.",
        hi: "рдлрд╕рд▓ рд╕реНрд╡рд╕реНрде рджрд┐рдЦ рд░рд╣реА рд╣реИред рдЙрдЪрд┐рдд рд╕рд┐рдВрдЪрд╛рдИ рдФрд░ рдирд┐рдпрдорд┐рдд рдирд┐рд░реАрдХреНрд╖рдг рдЬрд╛рд░реА рд░рдЦреЗрдВред"
      };
    }

    return { en: "", hi: "" };
  }

  function applyLang() {
    document.getElementById("title").innerText = T[lang].title;
    document.getElementById("btnCorrect").innerText = T[lang].correct;
    document.getElementById("btnWrong").innerText = T[lang].wrong;
    document.getElementById("btnExpert").innerText = T[lang].expert;

    document.getElementById("langToggle").innerText =
      (lang === "en") ? "ЁЯМР рд╣рд┐рдВрджреА" : "ЁЯМР English";

    if (lastPrediction) {
      const treatmentData = getTreatment(lastPrediction.className);
      document.getElementById("treatment").innerText = treatmentData[lang];
      document.getElementById("result").innerText =
        T[lang].predPrefix +
        lastPrediction.className +
        " (" +
        (lastPrediction.probability * 100).toFixed(2) +
        "%)";
    }
  }

  document.getElementById("langToggle").onclick = function() {
    lang = (lang === "en") ? "hi" : "en";
    applyLang();
  };

  applyLang();

  async function loadModel() {
    model = await tmImage.load("./model.json", "./metadata.json");
    modelReady = true;
    console.log("Model Loaded Successfully");
  }

  loadModel();

  document.getElementById("imageUpload").addEventListener("change", async function (event) {

    if (!modelReady) {
      alert("Model is still loading. Please wait a few seconds and try again.");
      return;
    }

    const file = event.target.files[0];
    if (!file) return;

    const img = document.createElement("img");
    img.src = window.URL.createObjectURL(file);
    img.width = 300;

    const preview = document.getElementById("preview");
    preview.innerHTML = "";
    preview.appendChild(img);

    img.onload = async () => {

      const prediction = await model.predict(img);
      prediction.sort((a, b) => b.probability - a.probability);

      const top = prediction[0];
      const confidence = top.probability * 100;

      lastPrediction = top;

      const warningEl = document.getElementById("warning");
      warningEl.style.display = "none";
      warningEl.innerText = "";
      document.getElementById("btnExpert").classList.remove("low-confidence");

      if (confidence < 70) {
        warningEl.style.display = "block";
        warningEl.innerText = T[lang].lowConf;
        document.getElementById("btnExpert").classList.add("low-confidence");
      }

      const treatmentData = getTreatment(top.className);
      document.getElementById("treatment").innerText = treatmentData[lang];

      document.getElementById("result").innerText =
        T[lang].predPrefix +
        top.className +
        " (" +
        confidence.toFixed(2) +
        "%)";

      document.getElementById("actions").style.display = "block";

      document.getElementById("btnExpert").onclick = function() {
        window.open(
          "https://wa.me/919999955233?text=" +
          encodeURIComponent(
            "KisanAI Result:\n" +
            top.className +
            " (" +
            confidence.toFixed(2) +
            "%)"
          ),
          "_blank"
        );
      };

      document.getElementById("btnCorrect").onclick = function() {
        openFeedbackForm("Yes");
      };

      document.getElementById("btnWrong").onclick = function() {
        openFeedbackForm("No");
      };
    };
  });

  function openFeedbackForm(correctValue) {
    if (!lastPrediction) return;

    const disease = encodeURIComponent(lastPrediction.className);
    const conf = encodeURIComponent((lastPrediction.probability * 100).toFixed(2));
    const correct = encodeURIComponent(correctValue);

    const url =
      FORM_BASE +
      "&entry.1340582940=" + disease +
      "&entry.432078826=" + conf +
      "&entry.2027263940=" + correct;

    window.open(url, "_blank");
  }

</script>

</body>
</html>
