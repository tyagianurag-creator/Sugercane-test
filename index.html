<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KisanAI üåæ</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#f6f7fb;
      margin:0;
      padding:24px 14px;
    }
    .container{ max-width:520px; margin:0 auto; }
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      font-size:22px; background:#fff; border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .brandTitle{ font-size:22px; font-weight:800; line-height:1.1; }
    .tagline{ font-size:13px; color:#555; margin-top:2px; }
    .card{
      background:#fff; border-radius:18px; padding:16px;
      box-shadow:0 10px 24px rgba(0,0,0,0.07);
    }
    input[type="file"]{
      width:100%; padding:12px; border:1px solid #e7e7ef;
      border-radius:12px; background:#fafafe;
    }
    #preview img{ margin-top:12px; border-radius:14px; max-width:100%; }
    .result{ margin-top:14px; font-size:18px; font-weight:700; }
    .warning{
      margin-top:10px; padding:10px 12px; background:#fff1f1;
      border:1px solid #ffd6d6; border-radius:14px; color:#b71c1c; font-weight:700;
    }
    .treatment{
      margin-top:10px; padding:10px 12px; background:#f3fff4;
      border:1px solid #cdf5d0; border-radius:14px; color:#1b5e20;
    }
    button{
      padding:10px 12px; margin:6px 6px 0 0; font-size:15px;
      border-radius:12px; border:1px solid transparent; cursor:pointer;
    }
    .primary{ background:#1b5e20; color:white; }
    .secondary{ background:#eef0f6; color:#111; border-color:#e1e4ee; }
    .whatsapp{ background:#25D366; color:white; }
    .ghost{ background:transparent; border-color:#e1e4ee; }
    .low-confidence{ border:2px solid #b71c1c !important; }
    .footer{ margin-top:12px; font-size:12px; color:#666; text-align:center; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">üåæ</div>
        <div>
          <div id="title" class="brandTitle">KisanAI</div>
          <div id="tagline" class="tagline">AI help for crops & farmers</div>
        </div>
      </div>
      <button id="langToggle" class="ghost">Switch to ‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
    </div>

    <div class="card">
      <input type="file" id="imageUpload" accept="image/*">
      <div id="preview"></div>

      <div id="result" class="result"></div>
      <div id="warning" class="warning" style="display:none;"></div>
      <div id="treatment" class="treatment"></div>

      <div id="actions" style="margin-top:16px; display:none;">
        <button id="btnCorrect" class="primary">‚úÖ Correct</button>
        <button id="btnWrong" class="secondary">‚ùå Wrong</button>
        <button id="btnExpert" class="whatsapp">üí¨ WhatsApp Expert</button>
      </div>
    </div>

    <div class="footer">
      <span>For best results: take a close, clear photo in daylight.</span>
    </div>
  </div>

<script>
  let model;
  let modelReady = false;

  let lastPrediction = null;
  let lastConfidence = null;

  const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSem_oTTQBtdWz8NBy8Joh0WTU6NHorbT4O8eHg6-ysgozgjBg/viewform?usp=pp_url";

  let lang = localStorage.getItem("kisanai_lang") || "en";

  const T = {
    en: {
      title: "KisanAI üåæ",
      tagline: "AI help for crops & farmers",
      correct: "‚úÖ Correct",
      wrong: "‚ùå Wrong",
      expert: "üí¨ WhatsApp Expert",
      lowConf: "‚ö†Ô∏è Low confidence. Please take a clearer photo or consult expert on WhatsApp.",
      predPrefix: "Prediction: ",
      switchTo: "Switch to ‡§π‡§ø‡§Ç‡§¶‡•Ä"
    },
    hi: {
      title: "‡§ï‡§ø‡§∏‡§æ‡§® AI üåæ",
      tagline: "‡§´‡§∏‡§≤‡•ã‡§Ç ‡§î‡§∞ ‡§ï‡§ø‡§∏‡§æ‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è AI ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ",
      correct: "‚úÖ ‡§∏‡§π‡•Ä",
      wrong: "‚ùå ‡§ó‡§≤‡§§",
      expert: "üí¨ WhatsApp ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ",
      lowConf: "‚ö†Ô∏è ‡§ï‡§Æ ‡§≠‡§∞‡•ã‡§∏‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§æ‡§´‡§º ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç ‡§Ø‡§æ WhatsApp ‡§™‡§∞ ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç‡•§",
      predPrefix: "‡§®‡§§‡•Ä‡§ú‡§æ: ",
      switchTo: "Switch to English"
    }
  };

  function getTreatment(disease) {
    const d = (disease || "").toLowerCase();

    if (d.includes("red")) {
      return {
        en: "Remove infected plants. Avoid water stagnation. Use recommended fungicide.",
        hi: "‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§ø‡§§ ‡§™‡•å‡§ß‡•á ‡§π‡§ü‡§æ‡§è‡§Ç‡•§ ‡§ñ‡•á‡§§ ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§®‡•Ä ‡§ú‡§Æ‡§æ ‡§® ‡§π‡•ã‡§®‡•á ‡§¶‡•á‡§Ç‡•§ ‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§ ‡§´‡§´‡•Ç‡§Ç‡§¶‡§®‡§æ‡§∂‡§ï ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§"
      };
    }

    if (d.includes("smut")) {
      return {
        en: "Remove smut whips early. Use disease-free seed cane. Avoid ratoon from infected fields.",
        hi: "‡§∏‡•ç‡§Æ‡§ü ‡§µ‡•ç‡§π‡§ø‡§™‡•ç‡§∏ ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§π‡§ü‡§æ‡§è‡§Ç‡•§ ‡§∞‡•ã‡§ó‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§¨‡•Ä‡§ú ‡§≤‡•á‡§Ç‡•§ ‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§ø‡§§ ‡§ñ‡•á‡§§ ‡§∏‡•á ‡§∞atoon ‡§® ‡§≤‡•á‡§Ç‡•§"
      };
    }

    if (d.includes("healthy")) {
      return {
        en: "Crop looks healthy. Maintain proper irrigation and regular inspection.",
        hi: "‡§´‡§∏‡§≤ ‡§∏‡•ç‡§µ‡§∏‡•ç‡§• ‡§¶‡§ø‡§ñ ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ ‡§â‡§ö‡§ø‡§§ ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§î‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç‡•§"
      };
    }

    return { en: "", hi: "" };
  }

  function renderWarning() {
    const warningEl = document.getElementById("warning");
    const expertBtn = document.getElementById("btnExpert");

    warningEl.style.display = "none";
    warningEl.innerText = "";
    expertBtn.classList.remove("low-confidence");

    if (lastConfidence !== null && lastConfidence < 70) {
      warningEl.style.display = "block";
      warningEl.innerText = T[lang].lowConf;
      expertBtn.classList.add("low-confidence");
    }
  }

  function applyLang() {
    document.getElementById("title").innerText = T[lang].title;
    document.getElementById("tagline").innerText = T[lang].tagline;

    document.getElementById("btnCorrect").innerText = T[lang].correct;
    document.getElementById("btnWrong").innerText = T[lang].wrong;
    document.getElementById("btnExpert").innerText = T[lang].expert;

    document.getElementById("langToggle").innerText = T[lang].switchTo;

    if (lastPrediction) {
      document.getElementById("result").innerText =
        T[lang].predPrefix + lastPrediction.className +
        " (" + (lastConfidence ?? (lastPrediction.probability * 100)).toFixed(2) + "%)";

      const treatmentData = getTreatment(lastPrediction.className);
      document.getElementById("treatment").innerText = treatmentData[lang] || "";
    }

    renderWarning();
  }

  document.getElementById("langToggle").onclick = function() {
    lang = (lang === "en") ? "hi" : "en";
    localStorage.setItem("kisanai_lang", lang);
    applyLang();
  };

  applyLang();

  async function loadModel() {
    model = await tmImage.load("./model.json", "./metadata.json");
    modelReady = true;
    console.log("Model Loaded Successfully");
  }
  loadModel();

  document.getElementById("imageUpload").addEventListener("change", async function (event) {
    if (!modelReady) {
      alert("Model is still loading. Please wait a few seconds and try again.");
      return;
    }

    const file = event.target.files[0];
    if (!file) return;

    const img = document.createElement("img");
    img.src = window.URL.createObjectURL(file);
    img.width = 300;

    const preview = document.getElementById("preview");
    preview.innerHTML = "";
    preview.appendChild(img);

    img.onload = async () => {
      const prediction = await model.predict(img);
      prediction.sort((a, b) => b.probability - a.probability);

      const top = prediction[0];
      const confidence = top.probability * 100;

      lastPrediction = top;
      lastConfidence = confidence;

      const treatmentData = getTreatment(top.className);
      document.getElementById("treatment").innerText = treatmentData[lang] || "";

      document.getElementById("result").innerText =
        T[lang].predPrefix + top.className + " (" + confidence.toFixed(2) + "%)";

      renderWarning();

      document.getElementById("actions").style.display = "block";

      document.getElementById("btnExpert").onclick = function() {
        window.open(
          "https://wa.me/919999955233?text=" +
          encodeURIComponent("KisanAI Result:\n" + top.className + " (" + confidence.toFixed(2) + "%)"),
          "_blank"
        );
      };

      document.getElementById("btnCorrect").onclick = function() { openFeedbackForm("Yes"); };
      document.getElementById("btnWrong").onclick = function() { openFeedbackForm("No"); };
    };
  });

  function openFeedbackForm(correctValue) {
    if (!lastPrediction) return;

    const disease = encodeURIComponent(lastPrediction.className);
    const conf = encodeURIComponent((lastConfidence ?? (lastPrediction.probability * 100)).toFixed(2));
    const correct = encodeURIComponent(correctValue);

    const url =
      FORM_BASE +
      "&entry.1340582940=" + disease +
      "&entry.432078826=" + conf +
      "&entry.2027263940=" + correct;

    window.open(url, "_blank");
  }
</script>
</body>
</html>
